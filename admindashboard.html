<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Portfolio Admin</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/1.6.2/axios.min.js"></script>
</head>
<body>
    <div class="container">
        <div class="card" id="loginSection">
            <h2>Login</h2>
            <form id="loginForm">
                <div class="form-group">
                    <label>Username</label>
                    <input type="text" id="username" required>
                </div>
                <div class="form-group">
                    <label>Password</label>
                    <input type="password" id="password" required>
                </div>
                <button type="submit">Login</button>
            </form>
        </div>

        <div id="adminPanel" class="hidden">
            <div class="tab-buttons">
                <button onclick="showTab('projects')" class="active-tab">Projects</button>
                <button onclick="showTab('messages')">Messages</button>
                <button onclick="logout()">Logout</button>
            </div>

            <div id="projectsTab">
                <div class="card">
                    <h2>Add New Project</h2>
                    <form id="projectForm">
                        <div class="form-group">
                            <label>Title</label>
                            <input type="text" id="projectTitle" required>
                        </div>
                        <div class="form-group">
                            <label>Description</label>
                            <textarea id="projectDescription" required></textarea>
                        </div>
                        <div class="form-group">
                            <label>Image</label>
                            <input type="file" id="projectImage" accept="image/*">
                        </div>
                        <div class="form-group">
                            <label>Link</label>
                            <input type="text" id="projectLink">
                        </div>
                        <div class="form-group">
                            <label>Category</label>
                            <input type="text" id="projectCategory">
                        </div>
                        <button type="submit">Add Project</button>
                    </form>
                </div>

                <h2>Projects</h2>
                <div class="projects-grid" id="projectsList"></div>
            </div>

            <div id="messagesTab" class="hidden">
                <h2>Contact Messages</h2>
                <div class="messages-list" id="messagesList"></div>
            </div>
        </div>
    </div>

    <script>
        let token = localStorage.getItem('token');
        const API_URL = 'http://localhost:5000/api';

        // Show/hide sections based on login status
        function checkAuth() {
            if (token) {
                document.getElementById('loginSection').classList.add('hidden');
                document.getElementById('adminPanel').classList.remove('hidden');
                loadProjects();
                loadMessages();
            } else {
                document.getElementById('loginSection').classList.remove('hidden');
                document.getElementById('adminPanel').classList.add('hidden');
            }
        }

        // Login form submission
        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            try {
                const response = await axios.post(`${API_URL}/auth/login`, {
                    username: document.getElementById('username').value,
                    password: document.getElementById('password').value
                });
                
                token = response.data.token;
                localStorage.setItem('token', token);
                checkAuth();
            } catch (error) {
                alert('Login failed: ' + error.response?.data?.message || error.message);
            }
        });

        // Add new project
        document.getElementById('projectForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData();
            formData.append('title', document.getElementById('projectTitle').value);
            formData.append('description', document.getElementById('projectDescription').value);
            formData.append('link', document.getElementById('projectLink').value);
            formData.append('category', document.getElementById('projectCategory').value);
            
            const imageFile = document.getElementById('projectImage').files[0];
            if (imageFile) {
                formData.append('image', imageFile);
            }

            try {
                await axios.post(`${API_URL}/projects`, formData, {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'multipart/form-data'
                    }
                });
                
                alert('Project added successfully!');
                loadProjects();
                e.target.reset();
            } catch (error) {
                alert('Failed to add project: ' + error.response?.data?.message || error.message);
            }
        });

        // Load projects
        async function loadProjects() {
            try {
                const response = await axios.get(`${API_URL}/projects`);
                const projectsList = document.getElementById('projectsList');
                projectsList.innerHTML = '';
                
                response.data.forEach(project => {
                    const projectCard = document.createElement('div');
                    projectCard.className = 'project-card';
                    projectCard.innerHTML = `
                        ${project.imageUrl ? `<img src="http://localhost:5000${project.imageUrl}" alt="${project.title}">` : ''}
                        <h3>${project.title}</h3>
                        <p>${project.description}</p>
                        <p>Category: ${project.category || 'Uncategorized'}</p>
                        ${project.link ? `<p><a href="${project.link}" target="_blank">View Project</a></p>` : ''}
                        <button onclick="deleteProject('${project._id}')">Delete</button>
                    `;
                    projectsList.appendChild(projectCard);
                });
            } catch (error) {
                console.error('Error loading projects:', error);
            }
        }

        // Load messages
        async function loadMessages() {
            try {
                const response = await axios.get(`${API_URL}/contact`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                const messagesList = document.getElementById('messagesList');
                messagesList.innerHTML = '';
                
                response.data.forEach(message => {
                    const messageItem = document.createElement('div');
                    messageItem.className = 'message-item';
                    messageItem.innerHTML = `
                        <h3>${message.name} (${message.email})</h3>
                        <p>${message.message}</p>
                        <small>Sent on: ${new Date(message.createdAt).toLocaleString()}</small>
                    `;
                    messagesList.appendChild(messageItem);
                });
            } catch (error) {
                console.error('Error loading messages:', error);
            }
        }

        // Delete project
        async function deleteProject(id) {
            if (confirm('Are you sure you want to delete this project?')) {
                try {
                    await axios.delete(`${API_URL}/projects/${id}`, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    loadProjects();
                } catch (error) {
                    alert('Failed to delete project: ' + error.response?.data?.message || error.message);
                }
            }
        }

        // Tab switching
        function showTab(tabName) {
            document.querySelectorAll('.tab-buttons button').forEach(btn => btn.classList.remove('active-tab'));
            event.target.classList.add('active-tab');
            
            if (tabName === 'projects') {
                document.getElementById('projectsTab').classList.remove('hidden');
                document.getElementById('messagesTab').classList.add('hidden');
            } else {
                document.getElementById('projectsTab').classList.add('hidden');
                document.getElementById('messagesTab').classList.remove('hidden');
            }
        }

        // Logout
        function logout() {
            localStorage.removeItem('token');
            token = null;
            checkAuth();
        }

        // Initial check
        checkAuth();
    </script>
</body>
</html>